---
title: 从4.0升级
permalink: upgrade-guide
category: 介绍
---
= 从4.0升级

toc::[]

4.1版本包含一系列*错误修复*和*API改进*，以保持代码基础简单且不复杂。 我试着让变化的东西少些，尽管如此还是不能一点没有。

== 起步

第一步是获取所有依赖项的最新版本。 我个人使用link:https://www.npmjs.com/package/npm-check[npm-check]来拉取最新版本的软件包。

[source, bash]
----
npm install -g npm-check
----

运行以下命令交互式更新依赖项。

[source, bash]
----
npm-check -u
----

== 异常处理
其中一个最大的改变已经在link:https://github.com/adonisjs/adonis-framework/issues/718[全局异常处理器]完成

在 `app/Exceptions/Handler.js` 文件中进行一下更改. 如果你从未创建过全局异常处理器，请忽略此部分。

1. 确保你的异常处理器继承 `BaseExceptionHandler`.
+
[source, js]
----
const BaseExceptionHandler = use('BaseExceptionHandler')

class ExceptionHandler extends BaseExceptionHandler {
}
----

2. 调用 `super.handle` 来处理你不想处理的异常。
+
[source, js]
----
class ExceptionHandler extends BaseExceptionHandler {
  async handle (error, { response }) {
    if (error.name === 'UserNotFoundException') {
      // handle it yourself
      return
    }

    super.handle(...arguments)
  }
}
----

3. 最后，您可以从代码库中移除 `Exception.bind` 调用，因为所有异常都将被路由到全局异常处理程序。

== 路由

==== Route.url

The `Route.url` 为预注册路由生成一个完全限定路由。 早前 `domain` 以字符串形式传递，现在它被接受为对象。

早前
[source, js]
----
Route.url('posts/:id', { id: 1 }, 'blog.adonisjs.com')
----

现在
[source, js]
----
Route.url('posts/:id', { id: 1 }, { domain: 'blog.adonisjs.com' })
----

== 验证器
验证器使用的是最新版的Indicative. 这里列出了一些由于Indicative更新做出的一些更改。

==== 格式器
这里没有更多的格式器命名概念. 如果你想使用一个预先存在的格式器, 将它作为引用传递，而不是传递它的名称。

早前
[source, js]
----
const { validate } = use('Validator')
validate(data, rules, messages, 'jsonapi')
----

现在
[source, js]
----
const { validate, formatters } = use('Validator')
validate(data, rules, messages, formatters.JsonApi)
----

这同样适用于路由验证器。

早前
[source, js]
----
class StoreUser {
  get formatter () {
    return 'jsonapi'
  }
}
----

现在
[source, js]
----
const { formatters } = use('Validator')

class StoreUser {
  get formatter () {
    return formatters.JsonApi
  }
}
----

==== 配置
新版本的Indicative公开了link:http://indicative.adonisjs.com/docs/api/configure[配置]方法来定义库的默认值。 它们也可以与验证器一起使用。

[source, js]
----
const { formatters, configure } = use('Validator')

configure({
  FORMATTER: formatters.JsonApi
})
----

== Lucid
日期格式与新创建的记录和已有的记录不一致。在新的版本中，同样的问题也被修正了。一定要阅读的link:https://github.com/adonisjs/adonis-lucid/issues/245[related issue]。

==== 日期
在模型实例上，日期字段将被更持久地转换为 `moment` 实例。例如

早前
[source, js]
----
const user = await User.find(1)
user.created_at instanceof moment // true
----

现在
[source, js]
----
const user = await User.find(1)
user.created_at instanceof moment // false
----

此更改可防止您直接在模型实例上更改日期，而是在序列化模型属性时使用 `castdate` 钩子来更改日期。

`castDates` 钩子会像以前一样工作。

[source, js]
----
class User extends Model {
  static castDates (field, value) {
    if (field === 'dob') {
      return `${value.fromNow(true)} old`
    }
    return super.formatDates(field, value)
  }
}
----

== Goodies（美味的？）
为了保持代码库的可靠性，已经进行了大量的bug修复。此外，还做了一些改进。

==== 验证器
Since indicative is written from groundup, the new version is `2x faster` than the old one.
由于indicative是又groundup编写，所以新版本比旧版本快2倍。

==== 中间件
中间件解析层现在在启动应用程序时解析所有中间件，并为每个请求实例化它们的一个新实例。而之前的*解析*过程是针对每个请求而完成的。

==== 优化报错
报错将以一种很好的格式化方式显示在您的终端上，如屏幕截图所示。

image:https://pbs.twimg.com/media/DTHfXErU8AADIyQ.png[]
